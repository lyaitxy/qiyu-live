红包雨接口：

- 根据主播id查询有无发放红包雨的权限

- 根据code查询已准备的红包雨配置

- 新增红包雨配置

  这里会给红包雨配置增加一个configCode（UUID），因为主播在一场直播中可能会发送多个红包

- 更新红包雨配置

- 主播开始准备红包雨

  加锁防止重复生成，二倍均值法生成红包列表，拆分为多个小列表存入redis中，防止输入输出缓冲区溢出，再修改红包雨配置的状态为已准备，防止重复生成，最后在redis中设置该红包雨已准备好的标记

- 直播间用户领取红包

  根据code从redis中获取一个红包，mq异步进行用户余额的增加，显示redis中余额的增加，再是异步mysql中余额的增加。最后统计红包的领取次数和领取金额（这里使用了redis中hash结构，code对应key）

- 开始红包雨

  从redis中查询该红包雨是否已准备好，并设置rediskey防止重复，广播通知直播间用户开始抢红包，更新红包雨的配置为已发送。

带货秒杀接口：

- 根据主播id查询商品列表

  使用redis中hash结构来缓存，key为skuID，value为sku信息

- 根据skuID查询商品详情信息

购物车接口：

- 添加购物车
- 移除购物车
- 清空购物车
- 修改购物车中某个商品的数量
- 查看购物车信息

带货秒杀实现

无需持久化，在redis中进行操作。主播先进行预热操作，将库存数目存入redis中，定时任务，每15秒刷新一次缓存中的库存到mysql。库存扣减需要先检验，再记录流水记录，最后执行库存扣减，使用lua脚本进行原子性操作。库存扣减成功，异步延迟半小时检查订单的状态，未支付则回滚库存。


送礼流程的实现（大并发场景，DB扛不住）

- 对im服务器进行水平扩容
- redis中存入账户余额数目
- 再发送异步mq消息处理余额扣减，在redis中设置UUID避免消息的重复消费。先检查余额是否充足，redis中的余额扣减，再异步进行mysql中的余额扣减，并记录流水
- 余额扣减成功后，推送礼物特效到直播间，如果是PK直播间，还要推送PK进度值。使用时间戳来保证消息的有序，lua脚本保证进度值的原子性的增加或减少
- 余额扣减失败，就单点推送失败消息给用户
